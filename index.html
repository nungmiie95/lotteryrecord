<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery Pro - Cloud System</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #FAFAFA; color: #333; }
        h1, h2, h3, .font-heading { font-family: 'Prompt', sans-serif; }
        
        /* Modern Inputs */
        .modern-input { @apply w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none transition-all focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100; }
        
        /* Modern Card */
        .modern-card { @apply bg-white rounded-2xl border border-gray-100 shadow-[0_8px_30px_rgb(0,0,0,0.04)]; }
        
        /* Table */
        .clean-table th { @apply text-left text-xs font-semibold text-gray-400 uppercase tracking-wider px-6 py-4 bg-gray-50/50 border-b border-gray-100; }
        .clean-table td { @apply px-6 py-4 text-sm text-gray-600 border-b border-gray-50; }
        .clean-table tr:last-child td { @apply border-b-0; }
        .clean-table tr:hover td { @apply bg-indigo-50/30; }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }
    </style>
</head>
<body class="h-screen overflow-hidden bg-gray-50">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Configuration ---
        const API_URL = "https://script.google.com/macros/s/AKfycbx8vrpVJKtCt7vou3AgyqmCBlgkOgo1JqvBZhSrf2KgCTXpXUA_QM6_diAGlPcStZtO/exec";
        const ITEM_TYPES = ['ลอตเตอรี่', '3N', 'อื่นๆ'];

        // --- Components ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
            const colors = type === 'success' ? 'bg-emerald-600' : 'bg-rose-600';
            return (
                <div className={`fixed top-6 left-1/2 -translate-x-1/2 flex items-center gap-3 px-6 py-3 rounded-full shadow-xl z-50 animate-fade-in ${colors} text-white`}>
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const StatCard = ({ title, value, icon, accentColor }) => (
            <div className="modern-card p-6 flex items-start justify-between hover:-translate-y-1 transition-transform duration-300">
                <div>
                    <p className="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">{title}</p>
                    <h3 className="text-3xl font-heading font-bold text-gray-800">{value}</h3>
                </div>
                <div className={`p-3 rounded-2xl ${accentColor} bg-opacity-10`}>
                    <Icon name={icon} className={accentColor.replace('bg-', 'text-')} size={24} />
                </div>
            </div>
        );

        // --- Main App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [toast, setToast] = useState(null);
            const [loading, setLoading] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            
            // Data
            const [periods, setPeriods] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [sales, setSales] = useState([]);
            const [currentPeriodId, setCurrentPeriodId] = useState('');

            // Initial Load
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
                loadData();
            }, []);

            // Helper Functions
            const showToast = (msg, type = 'success') => setToast({ message: msg, type });

            const loadData = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}?action=read`);
                    const data = await res.json();
                    if (data.periods) {
                        setPeriods(data.periods);
                        setInventory(data.inventory);
                        setSales(data.sales);
                        // Set current period to latest if not set
                        if (data.periods.length > 0 && !currentPeriodId) {
                            // Sort periods by date descending to get latest
                            const sorted = [...data.periods].sort((a,b) => new Date(b.date) - new Date(a.date));
                            setCurrentPeriodId(sorted[0].id);
                        }
                    }
                } catch (e) {
                    showToast("โหลดข้อมูลไม่สำเร็จ: " + e.message, "error");
                } finally {
                    setLoading(false);
                }
            };

            const saveData = async (newData) => {
                setIsSyncing(true);
                // Optimistic Update
                if (newData.periods) setPeriods(newData.periods);
                if (newData.inventory) setInventory(newData.inventory);
                if (newData.sales) setSales(newData.sales);

                const payload = {
                    periods: newData.periods || periods,
                    inventory: newData.inventory || inventory,
                    sales: newData.sales || sales
                };

                try {
                    await fetch(API_URL + "?action=sync", {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { "Content-Type": "text/plain" }
                    });
                } catch (e) {
                    showToast("บันทึกข้อมูลไม่สำเร็จ (ตรวจสอบอินเทอร์เน็ต)", "error");
                } finally {
                    setIsSyncing(false);
                }
            };

            // Calculations
            const getStats = (pId) => {
                const cost = inventory.filter(i => i.periodId === pId).reduce((sum, i) => sum + (i.totalCost || 0), 0);
                const revenue = sales.filter(s => s.periodId === pId).reduce((sum, s) => sum + (s.totalPrice || 0), 0);
                return { cost, revenue, profit: revenue - cost };
            };
            const currentStats = useMemo(() => getStats(currentPeriodId), [currentPeriodId, inventory, sales]);

            // Handlers
            const handleAddPeriod = () => {
                const date = prompt("วันที่งวดใหม่ (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
                if (date) {
                    const newId = `p_${Date.now()}`;
                    const newPeriods = [{ id: newId, date }, ...periods];
                    setCurrentPeriodId(newId);
                    saveData({ periods: newPeriods });
                    showToast("เพิ่มงวดใหม่เรียบร้อย");
                }
            };

            // --- Data Management Handlers ---
            const handleExport = () => {
                const data = { periods, inventory, sales, version: "cloud-v1" };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `lottery_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast("ส่งออกข้อมูล Backup สำเร็จ");
            };

            const handleImportJSON = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.periods && data.inventory && data.sales) {
                            if(confirm("คำเตือน: การนำเข้า Backup จะอัปโหลดขึ้น Google Sheet และแทนที่ข้อมูลเดิมทั้งหมด\nยืนยันที่จะทำต่อหรือไม่?")) {
                                saveData(data);
                                if (data.periods.length > 0) setCurrentPeriodId(data.periods[0].id);
                                showToast("กู้คืนข้อมูลและเริ่มซิงค์สำเร็จ");
                            }
                        } else {
                            showToast("รูปแบบไฟล์ Backup ไม่ถูกต้อง", "error");
                        }
                    } catch (err) {
                        showToast("ไม่สามารถอ่านไฟล์ได้", "error");
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const handleImportCSV = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    
                    let newPeriods = [...periods];
                    let newInventory = [...inventory];
                    let newSales = [...sales];
                    let count = 0;

                    lines.forEach((line, index) => {
                        if (index === 0) return; // Skip Header
                        const cols = line.split(',');
                        if (cols.length < 3) return;
                        
                        const date = cols[0]?.trim();
                        const cost = parseFloat(cols[1]) || 0;
                        const sale = parseFloat(cols[2]) || 0;
                        
                        if (date && (cost > 0 || sale > 0)) {
                            const pId = `p_csv_${Date.now()}_${index}`;
                            newPeriods.push({ id: pId, date: date });
                            
                            if (cost > 0) {
                                newInventory.push({
                                    id: `inv_csv_${Date.now()}_${index}`,
                                    periodId: pId,
                                    source: 'CSV Import',
                                    type: 'อื่นๆ', 
                                    qty: 1,
                                    unitCost: cost,
                                    totalCost: cost
                                });
                            }
                            
                            if (sale > 0) {
                                newSales.push({
                                    id: `sale_csv_${Date.now()}_${index}`,
                                    periodId: pId,
                                    date: date,
                                    customer: 'CSV Import',
                                    type: 'อื่นๆ',
                                    qty: 1,
                                    price: sale,
                                    totalPrice: sale,
                                    payment: 'เงินสด'
                                });
                            }
                            count++;
                        }
                    });
                    
                    if (count > 0) {
                        if(confirm(`พบข้อมูล ${count} รายการ ต้องการนำเข้าและอัปโหลดขึ้น Google Sheet หรือไม่?`)) {
                            saveData({ periods: newPeriods, inventory: newInventory, sales: newSales });
                            setCurrentPeriodId(newPeriods[newPeriods.length - 1].id);
                            showToast(`นำเข้า CSV สำเร็จ ${count} รายการ`);
                        }
                    } else {
                        showToast("ไม่พบข้อมูลที่นำเข้าได้ใน CSV", "error");
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            // --- Views ---
            const InventoryView = () => {
                const items = inventory.filter(i => i.periodId === currentPeriodId);
                const update = (newItems) => saveData({ inventory: newItems });

                return (
                    <div className="h-full flex flex-col animate-fade-in p-6 md:p-8 overflow-hidden">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-heading font-bold text-gray-800">จัดการต้นทุน</h2>
                                <p className="text-gray-500 text-sm">งวดวันที่ {periods.find(p=>p.id===currentPeriodId)?.date}</p>
                            </div>
                            <button onClick={() => update([...inventory, { id: Date.now(), periodId: currentPeriodId, source: '', type: 'ลอตเตอรี่', qty: 100, unitCost: 80, totalCost: 8000 }])} 
                                className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-sm font-medium shadow-lg shadow-indigo-500/20 flex items-center gap-2 transition-all">
                                <Icon name="plus" size={18} /> เพิ่มรายการ
                            </button>
                        </div>
                        <div className="modern-card flex-1 flex flex-col overflow-hidden">
                            <div className="overflow-auto flex-1 custom-scroll">
                                <table className="w-full clean-table">
                                    <thead className="sticky top-0 bg-white z-10 shadow-sm">
                                        <tr>
                                            <th>แหล่งที่มา</th>
                                            <th>ประเภท</th>
                                            <th className="text-right">จำนวน</th>
                                            <th className="text-right">ทุน/หน่วย</th>
                                            <th className="text-right">รวมเงิน</th>
                                            <th className="w-16"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {items.length === 0 ? <tr><td colSpan="6" className="text-center py-20 text-gray-400">ยังไม่มีข้อมูลต้นทุน</td></tr> : items.map(r => (
                                            <tr key={r.id}>
                                                <td className="p-2"><input className="modern-input" value={r.source} onChange={e => update(inventory.map(x => x.id === r.id ? {...x, source: e.target.value} : x))} placeholder="ระบุที่มา..." /></td>
                                                <td className="p-2 w-40">
                                                    <select className="modern-input cursor-pointer" value={r.type} onChange={e => update(inventory.map(x => x.id === r.id ? {...x, type: e.target.value} : x))}>
                                                        {ITEM_TYPES.map(t => <option key={t}>{t}</option>)}
                                                    </select>
                                                </td>
                                                <td className="p-2 w-32"><input type="number" className="modern-input text-right font-medium" value={r.qty} onChange={e => {
                                                    const val = parseFloat(e.target.value) || 0;
                                                    update(inventory.map(x => x.id === r.id ? {...x, qty: val, totalCost: val * x.unitCost} : x));
                                                }} /></td>
                                                <td className="p-2 w-32"><input type="number" className="modern-input text-right font-medium" value={r.unitCost} onChange={e => {
                                                    const val = parseFloat(e.target.value) || 0;
                                                    update(inventory.map(x => x.id === r.id ? {...x, unitCost: val, totalCost: val * x.qty} : x));
                                                }} /></td>
                                                <td className="text-right font-bold text-gray-700">฿{r.totalCost.toLocaleString()}</td>
                                                <td className="text-center"><button onClick={() => update(inventory.filter(x => x.id !== r.id))} className="text-gray-300 hover:text-rose-500 transition-colors"><Icon name="trash-2" size={18} /></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="bg-gray-50 p-4 border-t border-gray-100 flex justify-between items-center px-8">
                                <span className="text-sm font-semibold text-gray-500">รวมต้นทุนทั้งหมด</span>
                                <span className="text-xl font-bold text-gray-800">฿{currentStats.cost.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                );
            };

            const SalesView = () => {
                const items = sales.filter(s => s.periodId === currentPeriodId);
                const update = (newItems) => saveData({ sales: newItems });

                return (
                    <div className="h-full flex flex-col animate-fade-in p-6 md:p-8 overflow-hidden">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-heading font-bold text-gray-800">บันทึกยอดขาย</h2>
                                <p className="text-gray-500 text-sm">งวดวันที่ {periods.find(p=>p.id===currentPeriodId)?.date}</p>
                            </div>
                            <button onClick={() => update([...sales, { id: Date.now(), periodId: currentPeriodId, date: new Date().toISOString().split('T')[0], customer: '', type: 'ลอตเตอรี่', qty: 1, price: 100, totalPrice: 100 }])} 
                                className="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl text-sm font-medium shadow-lg shadow-emerald-500/20 flex items-center gap-2 transition-all">
                                <Icon name="plus" size={18} /> บันทึกขาย
                            </button>
                        </div>
                        <div className="modern-card flex-1 flex flex-col overflow-hidden">
                            <div className="overflow-auto flex-1 custom-scroll">
                                <table className="w-full clean-table">
                                    <thead className="sticky top-0 bg-white z-10 shadow-sm">
                                        <tr>
                                            <th className="w-40">วันที่</th>
                                            <th>ลูกค้า</th>
                                            <th>ประเภท</th>
                                            <th className="text-right">ราคา</th>
                                            <th className="text-right">จำนวน</th>
                                            <th className="text-right">รวมเงิน</th>
                                            <th className="w-16"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {items.length === 0 ? <tr><td colSpan="7" className="text-center py-20 text-gray-400">ยังไม่มียอดขาย</td></tr> : items.map(r => (
                                            <tr key={r.id}>
                                                <td className="p-2"><input type="date" className="modern-input text-gray-500" value={r.date} onChange={e => update(sales.map(x => x.id === r.id ? {...x, date: e.target.value} : x))} /></td>
                                                <td className="p-2"><input className="modern-input" value={r.customer} onChange={e => update(sales.map(x => x.id === r.id ? {...x, customer: e.target.value} : x))} placeholder="ลูกค้า..." /></td>
                                                <td className="p-2 w-40">
                                                    <select className="modern-input cursor-pointer" value={r.type} onChange={e => update(sales.map(x => x.id === r.id ? {...x, type: e.target.value} : x))}>
                                                        {ITEM_TYPES.map(t => <option key={t}>{t}</option>)}
                                                    </select>
                                                </td>
                                                <td className="p-2 w-32"><input type="number" className="modern-input text-right font-medium" value={r.price} onChange={e => {
                                                    const val = parseFloat(e.target.value) || 0;
                                                    update(sales.map(x => x.id === r.id ? {...x, price: val, totalPrice: val * x.qty} : x));
                                                }} /></td>
                                                <td className="p-2 w-32"><input type="number" className="modern-input text-right font-medium" value={r.qty} onChange={e => {
                                                    const val = parseFloat(e.target.value) || 0;
                                                    update(sales.map(x => x.id === r.id ? {...x, qty: val, totalPrice: val * x.price} : x));
                                                }} /></td>
                                                <td className="text-right font-bold text-emerald-600">฿{r.totalPrice.toLocaleString()}</td>
                                                <td className="text-center"><button onClick={() => update(sales.filter(x => x.id !== r.id))} className="text-gray-300 hover:text-rose-500 transition-colors"><Icon name="trash-2" size={18} /></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="bg-gray-50 p-4 border-t border-gray-100 flex justify-between items-center px-8">
                                <span className="text-sm font-semibold text-gray-500">ยอดขายรวมทั้งหมด</span>
                                <span className="text-xl font-bold text-emerald-600">฿{currentStats.revenue.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                );
            };

            const ReportsView = () => {
                const reportData = periods.map(p => {
                    const stats = getStats(p.id);
                    return { ...p, ...stats, margin: stats.cost > 0 ? (stats.profit / stats.cost) * 100 : 0 };
                }).sort((a, b) => new Date(b.date) - new Date(a.date));

                const totalProfit = reportData.reduce((sum, r) => sum + r.profit, 0);
                const bestPeriod = reportData.reduce((best, current) => (current.profit > best.profit ? current : best), reportData[0] || { profit: 0 });

                return (
                    <div className="h-full flex flex-col animate-fade-in p-6 md:p-8 overflow-hidden">
                        <h2 className="text-2xl font-heading font-bold text-gray-800 mb-6">รายงานสรุป (Reports)</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div className="modern-card p-6 border-l-4 border-indigo-500">
                                <p className="text-gray-500 text-sm mb-1">กำไรรวมทุกงวด</p>
                                <h3 className={`text-3xl font-bold ${totalProfit >= 0 ? 'text-indigo-600' : 'text-rose-600'}`}>
                                    {totalProfit >= 0 ? '+' : ''}{totalProfit.toLocaleString()}
                                </h3>
                            </div>
                            <div className="modern-card p-6 border-l-4 border-emerald-500">
                                <p className="text-gray-500 text-sm mb-1">งวดที่กำไรสูงสุด</p>
                                <h3 className="text-xl font-bold text-gray-800 mb-1">
                                    {bestPeriod.date ? new Date(bestPeriod.date).toLocaleDateString('th-TH', {day: 'numeric', month: 'long', year: '2-digit'}) : '-'}
                                </h3>
                                <p className="text-xs text-emerald-600">กำไร: {bestPeriod.profit?.toLocaleString()}</p>
                            </div>
                            <div className="modern-card p-6 border-l-4 border-gray-400">
                                <p className="text-gray-500 text-sm mb-1">จำนวนงวดทั้งหมด</p>
                                <h3 className="text-3xl font-bold text-gray-800">{periods.length} งวด</h3>
                            </div>
                        </div>
                        <div className="modern-card flex-1 flex flex-col overflow-hidden">
                            <div className="overflow-auto flex-1 custom-scroll">
                                <table className="w-full clean-table">
                                    <thead className="sticky top-0 bg-white z-10 shadow-sm">
                                        <tr>
                                            <th>งวดวันที่</th>
                                            <th className="text-right">ต้นทุน</th>
                                            <th className="text-right">ยอดขาย</th>
                                            <th className="text-right">กำไร/ขาดทุน</th>
                                            <th className="text-right">Margin</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {reportData.map(r => (
                                            <tr key={r.id}>
                                                <td className="font-medium">{new Date(r.date).toLocaleDateString('th-TH', {day: 'numeric', month: 'long', year: 'numeric'})}</td>
                                                <td className="text-right text-gray-500">{r.cost.toLocaleString()}</td>
                                                <td className="text-right text-gray-500">{r.revenue.toLocaleString()}</td>
                                                <td className={`text-right font-bold ${r.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                                    {r.profit.toLocaleString()}
                                                </td>
                                                <td className="text-right text-xs">
                                                    <span className={`px-2 py-1 rounded-full ${r.margin >= 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'}`}>
                                                        {r.margin.toFixed(1)}%
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const DataManagementView = () => (
                <div className="h-full flex flex-col animate-fade-in p-6 md:p-8 overflow-y-auto custom-scroll">
                    <h2 className="text-2xl font-heading font-bold text-gray-800 mb-2">จัดการข้อมูล (Data Management)</h2>
                    <p className="text-gray-500 mb-8">สำรองข้อมูล นำเข้า หรือกู้คืนข้อมูล</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="modern-card p-8 hover:shadow-lg transition-shadow">
                            <div className="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center mb-4"><Icon name="download" size={24} /></div>
                            <h3 className="text-lg font-bold text-gray-800 mb-2">ส่งออกข้อมูล (Backup)</h3>
                            <p className="text-sm text-gray-500 mb-6">ดาวน์โหลดข้อมูลทั้งหมดเก็บไว้เป็นไฟล์ .json เพื่อความปลอดภัย</p>
                            <button onClick={handleExport} className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-medium transition-all flex items-center justify-center gap-2"><Icon name="download" size={18} /> ดาวน์โหลด Backup</button>
                        </div>
                        <div className="modern-card p-8 hover:shadow-lg transition-shadow">
                            <div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center mb-4"><Icon name="upload" size={24} /></div>
                            <h3 className="text-lg font-bold text-gray-800 mb-2">นำเข้า Backup (.json)</h3>
                            <p className="text-sm text-gray-500 mb-6">กู้คืนข้อมูลจากไฟล์ Backup ที่เคยดาวน์โหลดไว้</p>
                            <div className="relative">
                                <input type="file" onChange={handleImportJSON} accept=".json" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                <button className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-all flex items-center justify-center gap-2 pointer-events-none"><Icon name="refresh-cw" size={18} /> เลือกไฟล์ Backup</button>
                            </div>
                        </div>
                        <div className="modern-card p-8 hover:shadow-lg transition-shadow md:col-span-2">
                            <div className="w-12 h-12 bg-orange-100 text-orange-600 rounded-xl flex items-center justify-center mb-4"><Icon name="file-spreadsheet" size={24} /></div>
                            <h3 className="text-lg font-bold text-gray-800 mb-2">นำเข้าจาก Excel/CSV</h3>
                            <p className="text-sm text-gray-500 mb-6">นำเข้าประวัติเก่าจากไฟล์ .csv (ต้องมีคอลัมน์: วันที่, ต้นทุน, ยอดขาย)</p>
                            <div className="relative">
                                <input type="file" onChange={handleImportCSV} accept=".csv" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                <button className="w-full py-3 bg-white border-2 border-orange-100 text-orange-600 hover:bg-orange-50 rounded-xl font-medium transition-all flex items-center justify-center gap-2 pointer-events-none"><Icon name="file-plus" size={18} /> เลือกไฟล์ CSV</button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const DashboardView = () => (
                <div className="max-w-5xl mx-auto py-8 px-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-10">
                        <div>
                            <h1 className="text-3xl font-heading font-bold text-gray-800">ภาพรวมธุรกิจ</h1>
                            <p className="text-gray-500 mt-1">ข้อมูลล่าสุดจาก Google Sheet</p>
                        </div>
                        {isSyncing && <div className="flex items-center gap-2 text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full text-xs font-medium animate-pulse"><Icon name="refresh-cw" size={14} className="animate-spin" /> กำลังบันทึก...</div>}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <StatCard title="ต้นทุน (Cost)" value={`฿${currentStats.cost.toLocaleString()}`} icon="package" accentColor="bg-rose-500" />
                        <StatCard title="รายรับ (Revenue)" value={`฿${currentStats.revenue.toLocaleString()}`} icon="trending-up" accentColor="bg-emerald-500" />
                        <StatCard title="กำไรสุทธิ (Profit)" value={`${currentStats.profit >= 0 ? '+' : ''}฿${currentStats.profit.toLocaleString()}`} icon="wallet" accentColor={currentStats.profit >= 0 ? "bg-indigo-600" : "bg-orange-500"} />
                    </div>

                    <h3 className="text-lg font-heading font-bold text-gray-700 mb-4">สถานะงวดบัญชี</h3>
                    {periods.length === 0 ? (
                        <div className="text-center py-10 bg-white rounded-2xl border border-gray-100 shadow-sm text-gray-400">ยังไม่มีงวดบัญชี กดปุ่ม "+" ด้านซ้ายเพื่อเริ่ม</div>
                    ) : (
                        <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                            <table className="w-full clean-table">
                                <thead className="bg-gray-50"><tr><th>งวดวันที่</th><th className="text-right">สถานะ</th></tr></thead>
                                <tbody>
                                    {periods.map(p => (
                                        <tr key={p.id} className={p.id === currentPeriodId ? "bg-indigo-50/40" : ""}>
                                            <td className="font-medium text-gray-800 flex items-center gap-3">
                                                {new Date(p.date).toLocaleDateString('th-TH', {day: 'numeric', month: 'long', year: 'numeric'})}
                                                {p.id === currentPeriodId && <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-indigo-100 text-indigo-700 tracking-wider">LATEST</span>}
                                            </td>
                                            <td className="text-right">
                                                <button onClick={() => {setCurrentPeriodId(p.id); setActiveTab('inventory');}} className="text-indigo-600 hover:text-indigo-800 text-sm font-semibold hover:underline">จัดการข้อมูล</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );

            // --- Layout ---
            if (loading && periods.length === 0) {
                return <div className="h-screen flex items-center justify-center bg-gray-50 text-gray-400 gap-3 flex-col"><div className="w-8 h-8 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div><p className="text-sm">กำลังเชื่อมต่อฐานข้อมูล...</p></div>;
            }

            return (
                <div className="flex h-full bg-gray-50">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {/* Sidebar */}
                    <aside className="w-72 bg-white border-r border-gray-100 flex flex-col z-20 shadow-xl shadow-gray-200/50">
                        <div className="p-8 pb-6">
                            <div className="flex items-center gap-3 mb-8">
                                <div className="w-10 h-10 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                                    <Icon name="cloud" size={20} />
                                </div>
                                <div><h1 className="font-heading font-bold text-xl text-gray-900 leading-none">Lottery Pro</h1><span className="text-xs font-medium text-gray-400">Cloud System</span></div>
                            </div>
                            
                            <div className="mb-6">
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 block px-1">งวดบัญชี</label>
                                <div className="relative group">
                                    <select value={currentPeriodId} onChange={(e) => setCurrentPeriodId(e.target.value)} className="w-full appearance-none bg-gray-50 hover:bg-gray-100 border-none rounded-xl px-4 py-3 text-sm font-medium text-gray-700 cursor-pointer outline-none transition-colors">
                                        {periods.map(p => <option key={p.id} value={p.id}>{new Date(p.date).toLocaleDateString('th-TH', {day: 'numeric', month: 'long', year: 'numeric'})}</option>)}
                                    </select>
                                    <Icon name="chevron-down" size={16} className="absolute right-4 top-3.5 text-gray-400 pointer-events-none" />
                                </div>
                                <button onClick={handleAddPeriod} className="mt-3 w-full border border-dashed border-gray-300 rounded-xl py-2.5 text-sm font-medium text-gray-500 hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2">
                                    <Icon name="plus-circle" size={16} /> เริ่มงวดใหม่
                                </button>
                            </div>
                        </div>

                        <nav className="flex-1 px-4 space-y-1.5 overflow-y-auto">
                            <div className="px-4 pb-2 pt-4 text-xs font-bold text-gray-400 uppercase tracking-wider">เมนูหลัก</div>
                            {[
                                { id: 'dashboard', label: 'ภาพรวม', icon: 'layout-dashboard' },
                                { id: 'inventory', label: 'จัดการต้นทุน', icon: 'package' },
                                { id: 'sales', label: 'บันทึกยอดขาย', icon: 'shopping-bag' },
                                { id: 'reports', label: 'รายงานสรุป', icon: 'file-text' },
                                { id: 'data', label: 'จัดการข้อมูล', icon: 'database' }
                            ].map(menu => (
                                <button key={menu.id} onClick={() => setActiveTab(menu.id)} 
                                    className={`w-full flex items-center gap-3.5 px-4 py-3.5 rounded-xl text-sm font-medium transition-all duration-200 group ${activeTab === menu.id ? 'bg-indigo-50 text-indigo-700 shadow-sm' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'}`}>
                                    <Icon name={menu.icon} size={20} className={activeTab === menu.id ? 'text-indigo-600' : 'text-gray-400 group-hover:text-gray-600'} />
                                    {menu.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-6 text-center text-xs text-gray-400">
                             {isSyncing ? <span className="flex items-center justify-center gap-2 text-indigo-500"><Icon name="refresh-cw" size={12} className="animate-spin" /> บันทึกอัตโนมัติ...</span> : "ซิงค์ข้อมูลล่าสุดแล้ว"}
                        </div>
                    </aside>

                    {/* Content */}
                    <main className="flex-1 overflow-hidden relative flex flex-col bg-white/50">
                        <div className="h-full overflow-y-auto overflow-x-hidden custom-scroll">
                            {activeTab === 'dashboard' && <DashboardView />}
                            {activeTab === 'inventory' && <InventoryView />}
                            {activeTab === 'sales' && <SalesView />}
                            {activeTab === 'reports' && <ReportsView />}
                            {activeTab === 'data' && <DataManagementView />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
