<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lottery Pro - Modern Cloud</title>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'], heading: ['Prompt', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(59, 130, 246, 0.5)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }
        .input-lg { @apply w-full bg-white border border-gray-200 rounded-xl px-4 py-3.5 text-base outline-none focus:border-brand-500 focus:ring-4 focus:ring-brand-100 transition-all shadow-sm; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .anim-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        button { touch-action: manipulation; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 overflow-hidden">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Config ---
        const API_URL = "https://script.google.com/macros/s/AKfycbx8vrpVJKtCt7vou3AgyqmCBlgkOgo1JqvBZhSrf2KgCTXpXUA_QM6_diAGlPcStZtO/exec";
        const ITEM_TYPES = ['ลอตเตอรี่', '3N', 'อื่นๆ'];

        // --- UI Components ---
        const Icon = ({ name, size = 24, className }) => {
            const ref = useRef(null);
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
            const bg = type === 'success' ? 'bg-emerald-600' : 'bg-rose-600';
            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-50 flex items-center gap-3 px-6 py-3 rounded-full shadow-xl text-white ${bg} anim-enter`}>
                    <Icon name={type === 'success' ? 'check-circle' : 'alert-circle'} size={20} />
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        const StatCard = ({ title, value, subtext, icon, color }) => (
            <div className="bg-white rounded-2xl p-5 shadow-soft border border-gray-100 flex items-center justify-between relative overflow-hidden group">
                <div className={`absolute right-0 top-0 w-24 h-24 bg-${color}-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`}></div>
                <div className="relative z-10">
                    <p className="text-sm text-gray-500 font-medium mb-1">{title}</p>
                    <h3 className={`text-3xl font-heading font-bold text-${color}-600`}>{value}</h3>
                    {subtext && <p className="text-xs text-gray-400 mt-1">{subtext}</p>}
                </div>
                <div className={`relative z-10 w-12 h-12 rounded-xl bg-${color}-100 flex items-center justify-center text-${color}-600`}>
                    <Icon name={icon} size={24} />
                </div>
            </div>
        );

        // --- Main App ---
        const App = () => {
            const [tab, setTab] = useState('dashboard');
            const [toast, setToast] = useState(null);
            const [loading, setLoading] = useState(true);
            const [syncing, setSyncing] = useState(false);
            
            // Data
            const [periods, setPeriods] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [sales, setSales] = useState([]);
            const [currPId, setCurrPId] = useState('');

            // Init
            useEffect(() => { loadData(); }, []);
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [tab, periods]);

            const showToast = (msg, type='success') => setToast({message: msg, type});

            const loadData = async () => {
                try {
                    const res = await fetch(`${API_URL}?action=read`);
                    const d = await res.json();
                    if (d.periods) {
                        setPeriods(d.periods);
                        setInventory(d.inventory);
                        setSales(d.sales);
                        if (d.periods.length > 0 && !currPId) {
                            const sorted = [...d.periods].sort((a,b) => new Date(b.date) - new Date(a.date));
                            setCurrPId(sorted[0].id);
                        }
                    }
                } catch(e) { showToast("โหลดข้อมูลไม่สำเร็จ: " + e.message, "error"); }
                finally { setLoading(false); }
            };

            const saveData = async (newData) => {
                setSyncing(true);
                // Optimistic Update
                if (newData.periods) setPeriods(newData.periods);
                if (newData.inventory) setInventory(newData.inventory);
                if (newData.sales) setSales(newData.sales);

                try {
                    await fetch(API_URL + "?action=sync", {
                        method: 'POST',
                        body: JSON.stringify({
                            periods: newData.periods || periods,
                            inventory: newData.inventory || inventory,
                            sales: newData.sales || sales
                        }),
                        headers: { "Content-Type": "text/plain" }
                    });
                } catch(e) { showToast("บันทึกไม่สำเร็จ (เน็ตหลุด?)", "error"); }
                finally { setSyncing(false); }
            };

            const getStats = (pId) => {
                const c = inventory.filter(i => i.periodId === pId).reduce((s, i) => s + (i.totalCost || 0), 0);
                const r = sales.filter(s => s.periodId === pId).reduce((s, x) => s + (x.totalPrice || 0), 0);
                return { cost: c, revenue: r, profit: r - c };
            };
            const currStats = useMemo(() => getStats(currPId), [currPId, inventory, sales]);

            // Handlers
            const addPeriod = () => {
                const d = prompt("วันที่งวดใหม่ (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
                if (d) {
                    const id = `p_${Date.now()}`;
                    const newP = [{id, date: d}, ...periods];
                    setCurrPId(id);
                    saveData({periods: newP});
                    setTab('inv'); // Go to inventory immediately
                    showToast("เริ่มงวดใหม่แล้ว");
                }
            };

            const editPeriodDate = (pId) => {
                const p = periods.find(x => x.id === pId);
                const newDate = prompt("แก้ไขวันที่ (YYYY-MM-DD):", p.date);
                if (newDate && newDate !== p.date) {
                    const newPeriods = periods.map(x => x.id === pId ? { ...x, date: newDate } : x);
                    saveData({ periods: newPeriods });
                    showToast("แก้ไขวันที่สำเร็จ");
                }
            };

            const deletePeriod = (pId) => {
                if (confirm("⚠️ ยืนยันลบงวดนี้?\nข้อมูลทั้งหมดในงวดนี้จะหายไป")) {
                    const newPeriods = periods.filter(x => x.id !== pId);
                    const newInventory = inventory.filter(x => x.periodId !== pId);
                    const newSales = sales.filter(x => x.periodId !== pId);
                    
                    if (currPId === pId) {
                        setCurrPId(newPeriods.length > 0 ? newPeriods[0].id : '');
                    }
                    
                    saveData({ periods: newPeriods, inventory: newInventory, sales: newSales });
                    showToast("ลบงวดเรียบร้อย");
                }
            };

            // Data Handlers
            const handleImportJSON = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.periods && json.inventory && json.sales) {
                            if (confirm('ข้อมูลปัจจุบันจะถูกแทนที่ ยืนยันการกู้คืน?')) {
                                saveData(json);
                                setPeriods(json.periods); setInventory(json.inventory); setSales(json.sales);
                                showToast('กู้คืนข้อมูลสำเร็จ');
                            }
                        } else showToast('ไฟล์ไม่ถูกต้อง', 'error');
                    } catch (ex) { showToast('อ่านไฟล์ไม่ได้', 'error'); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const handleImportCSV = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(l => l.trim());
                    let newPeriods = [...periods], newInv = [...inventory], newSales = [...sales], count = 0;
                    
                    lines.forEach((line, idx) => {
                        if (idx === 0) return;
                        const cols = line.split(',');
                        if (cols.length >= 3) {
                            const date = cols[0].trim(), cost = parseFloat(cols[1]), rev = parseFloat(cols[2]);
                            if (date && !isNaN(cost) && !isNaN(rev)) {
                                const pId = `p_imp_${Date.now()}_${idx}`;
                                newPeriods.push({id: pId, date});
                                if (cost > 0) newInv.push({ id: `inv_${pId}`, periodId: pId, source: 'Import', type: 'อื่นๆ', qty: 1, unitCost: cost, totalCost: cost });
                                if (rev > 0) newSales.push({ id: `sale_${pId}`, periodId: pId, date: date, customer: 'Import', type: 'อื่นๆ', qty: 1, price: rev, totalPrice: rev });
                                count++;
                            }
                        }
                    });

                    if (count > 0 && confirm(`พบข้อมูล ${count} รายการ นำเข้าหรือไม่?`)) {
                        saveData({ periods: newPeriods, inventory: newInv, sales: newSales });
                        setPeriods(newPeriods); setInventory(newInv); setSales(newSales);
                        showToast(`นำเข้า ${count} รายการสำเร็จ`);
                    } else if (count === 0) showToast('ไม่พบข้อมูลที่อ่านได้', 'error');
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            // --- Sub Views ---
            const ItemCard = ({ data, type, onSave, onDelete }) => {
                const [isEdit, setIsEdit] = useState(false);
                const [form, setForm] = useState({...data});

                const handleChange = (k, v) => {
                    setForm(prev => {
                        const next = {...prev, [k]: v};
                        if (type === 'inv') next.totalCost = (next.qty||0) * (next.unitCost||0);
                        if (type === 'sale') next.totalPrice = (next.qty||0) * (next.price||0);
                        return next;
                    });
                };

                if (isEdit) return (
                    <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-brand-100 mb-4 anim-enter">
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <div className="col-span-2">
                                <label className="text-xs text-gray-400">รายละเอียด</label>
                                <input className="input-lg" value={type==='inv'?form.source:form.customer} onChange={e=>handleChange(type==='inv'?'source':'customer', e.target.value)} placeholder={type==='inv'?'แหล่งที่มา':'ชื่อลูกค้า'} />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">ประเภท</label>
                                <select className="input-lg" value={form.type} onChange={e=>handleChange('type', e.target.value)}>{ITEM_TYPES.map(t=><option key={t}>{t}</option>)}</select>
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">วันที่</label>
                                <input type="date" className="input-lg text-sm px-2" value={type==='inv'?'':form.date} disabled={type==='inv'} onChange={e=>handleChange('date', e.target.value)} />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">จำนวน</label>
                                <input type="number" className="input-lg text-right" value={form.qty} onChange={e=>handleChange('qty', parseFloat(e.target.value))} />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">{type==='inv'?'ทุน/หน่วย':'ราคาขาย'}</label>
                                <input type="number" className="input-lg text-right" value={type==='inv'?form.unitCost:form.price} onChange={e=>handleChange(type==='inv'?'unitCost':'price', parseFloat(e.target.value))} />
                            </div>
                        </div>
                        <div className="flex gap-2 mt-4">
                            <button onClick={()=>{onSave(form); setIsEdit(false);}} className="flex-1 bg-brand-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">บันทึก</button>
                            <button onClick={()=>{setForm({...data}); setIsEdit(false);}} className="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold active:scale-95 transition">ยกเลิก</button>
                        </div>
                    </div>
                );

                return (
                    <div className="bg-white rounded-2xl p-4 shadow-soft mb-3 flex items-center justify-between group active:scale-[0.99] transition-transform" onClick={() => setIsEdit(true)}>
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                                <span className={`px-2.5 py-1 rounded-lg text-xs font-bold ${type==='inv'?'bg-indigo-50 text-indigo-600':'bg-emerald-50 text-emerald-600'}`}>{data.type}</span>
                                <span className="text-xs text-gray-400">{type==='inv'?'': new Date(data.date).toLocaleDateString('th-TH', {day:'numeric', month:'short'})}</span>
                            </div>
                            <h4 className="font-heading font-bold text-gray-800 text-lg">{type==='inv' ? (data.source||'ไม่ระบุที่มา') : (data.customer||'ลูกค้าทั่วไป')}</h4>
                            <p className="text-sm text-gray-500">
                                {data.qty.toLocaleString()} ใบ × ฿{type==='inv'?data.unitCost:data.price}
                            </p>
                        </div>
                        <div className="text-right pl-4">
                            <p className={`font-bold text-xl font-heading ${type==='inv'?'text-rose-600':'text-emerald-600'}`}>
                                ฿{(type==='inv'?data.totalCost:data.totalPrice).toLocaleString()}
                            </p>
                            <div className="flex gap-3 justify-end mt-2">
                                <button onClick={(e)=>{e.stopPropagation(); setIsEdit(true)}} className="p-2 text-brand-500 bg-brand-50 rounded-lg"><Icon name="pencil" size={18}/></button>
                                <button onClick={(e)=>{e.stopPropagation(); onDelete(data.id)}} className="p-2 text-rose-500 bg-rose-50 rounded-lg"><Icon name="trash-2" size={18}/></button>
                            </div>
                        </div>
                    </div>
                );
            };

            const ListView = ({ mode }) => {
                const items = mode==='inv' ? inventory.filter(i=>i.periodId===currPId) : sales.filter(s=>s.periodId===currPId);
                const update = (newItem) => {
                    const list = mode==='inv'?inventory:sales;
                    const updated = list.map(x => x.id === newItem.id ? newItem : x);
                    saveData(mode==='inv'?{inventory:updated}:{sales:updated});
                };
                const add = () => {
                    const newItem = mode==='inv' 
                        ? { id: Date.now(), periodId: currPId, source: '', type: 'ลอตเตอรี่', qty: 100, unitCost: 80, totalCost: 8000 }
                        : { id: Date.now(), periodId: currPId, date: new Date().toISOString().split('T')[0], customer: '', type: 'ลอตเตอรี่', qty: 1, price: 100, totalPrice: 100 };
                    saveData(mode==='inv'?{inventory:[newItem, ...inventory]}:{sales:[newItem, ...sales]});
                };
                const del = (id) => {
                    if(confirm('ลบรายการนี้?')) {
                        const list = mode==='inv'?inventory:sales;
                        saveData(mode==='inv'?{inventory:list.filter(x=>x.id!==id)}:{sales:list.filter(x=>x.id!==id)});
                    }
                };

                return (
                    <div className="flex-1 flex flex-col h-full bg-gray-50/50">
                        <div className="bg-white px-6 py-4 shadow-sm z-10 sticky top-0">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <h2 className="text-2xl font-heading font-bold text-gray-800">{mode==='inv'?'สต็อกต้นทุน':'ยอดขายรายวัน'}</h2>
                                    <p className="text-sm text-gray-500">งวด {periods.find(p=>p.id===currPId)?.date}</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-xs text-gray-400 font-bold uppercase tracking-wide">ยอดรวม</p>
                                    <p className={`text-2xl font-bold font-heading ${mode==='inv'?'text-rose-600':'text-emerald-600'}`}>
                                        ฿{(mode==='inv'?currStats.cost:currStats.revenue).toLocaleString()}
                                    </p>
                                </div>
                            </div>
                            <button onClick={add} className={`w-full py-3.5 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 active:scale-95 transition ${mode==='inv'?'bg-indigo-600 shadow-indigo-200':'bg-emerald-600 shadow-emerald-200'}`}>
                                <Icon name="plus-circle" size={20} /> เพิ่มรายการใหม่
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 custom-scroll pb-24">
                            {items.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-64 text-gray-400">
                                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4"><Icon name={mode==='inv'?'package':'shopping-cart'} size={32} /></div>
                                    <p>ยังไม่มีรายการ</p>
                                </div>
                            ) : (
                                items.map(item => <ItemCard key={item.id} data={item} type={mode} onSave={update} onDelete={del} />)
                            )}
                        </div>
                    </div>
                );
            };

            const ReportsView = () => {
                const reportData = useMemo(() => {
                    return periods.map(p => {
                        const s = getStats(p.id);
                        return { ...p, ...s, margin: s.cost > 0 ? (s.profit / s.cost) * 100 : 0 };
                    }).sort((a,b) => new Date(b.date) - new Date(a.date));
                }, [periods, inventory, sales]);

                const allTime = useMemo(() => reportData.reduce((acc, curr) => ({
                    cost: acc.cost + curr.cost,
                    revenue: acc.revenue + curr.revenue,
                    profit: acc.profit + curr.profit
                }), { cost: 0, revenue: 0, profit: 0 }), [reportData]);

                return (
                    <div className="flex-1 overflow-y-auto p-6 custom-scroll pb-24">
                        <h2 className="text-2xl font-heading font-bold text-gray-800 mb-6">รายงานสรุปผลประกอบการ</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                                <div className="absolute right-0 top-0 w-32 h-32 bg-white opacity-10 rounded-bl-full -mr-6 -mt-6"></div>
                                <p className="opacity-80 mb-1 text-sm font-medium">กำไรสะสม (Accumulated Profit)</p>
                                <h3 className="text-3xl font-bold font-heading">{allTime.profit > 0 ? '+' : ''}฿{allTime.profit.toLocaleString()}</h3>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-soft border border-gray-100 flex items-center justify-between">
                                <div><p className="text-gray-500 mb-1 text-sm font-medium">ยอดขายรวม</p><h3 className="text-2xl font-bold text-emerald-600">฿{allTime.revenue.toLocaleString()}</h3></div>
                                <div className="p-3 bg-emerald-50 rounded-xl text-emerald-600"><Icon name="trending-up" /></div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-soft border border-gray-100 flex items-center justify-between">
                                <div><p className="text-gray-500 mb-1 text-sm font-medium">ต้นทุนรวม</p><h3 className="text-2xl font-bold text-rose-600">฿{allTime.cost.toLocaleString()}</h3></div>
                                <div className="p-3 bg-rose-50 rounded-xl text-rose-600"><Icon name="package" /></div>
                            </div>
                        </div>
                        <h3 className="text-lg font-bold text-gray-700 mb-4">รายละเอียดรายงวด</h3>
                        <div className="bg-white rounded-2xl shadow-soft border border-gray-100 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left min-w-[600px]">
                                    <thead className="bg-gray-50 border-b border-gray-100">
                                        <tr><th className="p-4 text-xs font-bold text-gray-400 uppercase">งวดวันที่</th><th className="p-4 text-xs font-bold text-gray-400 uppercase text-right">ต้นทุน</th><th className="p-4 text-xs font-bold text-gray-400 uppercase text-right">ยอดขาย</th><th className="p-4 text-xs font-bold text-gray-400 uppercase text-right">กำไร</th><th className="p-4 text-xs font-bold text-gray-400 uppercase text-right">Margin</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-50">
                                        {reportData.map(r => (
                                            <tr key={r.id} className="hover:bg-gray-50/50 transition">
                                                <td className="p-4 font-medium text-gray-700">{new Date(r.date).toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'})}</td>
                                                <td className="p-4 text-right text-gray-500">{r.cost.toLocaleString()}</td>
                                                <td className="p-4 text-right text-emerald-600">{r.revenue.toLocaleString()}</td>
                                                <td className={`p-4 text-right font-bold ${r.profit >= 0 ? 'text-indigo-600' : 'text-rose-600'}`}>{r.profit.toLocaleString()}</td>
                                                <td className="p-4 text-right"><span className={`px-2 py-1 rounded-lg text-xs font-bold ${r.margin >= 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}`}>{r.margin.toFixed(1)}%</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const Dashboard = () => (
                <div className="flex-1 overflow-y-auto p-5 custom-scroll pb-24">
                    <div className="flex justify-between items-end mb-6">
                        <div>
                            <h1 className="text-3xl font-heading font-bold text-gray-800">ภาพรวม</h1>
                            <div className="flex items-center gap-2 mt-2">
                                <span className="bg-white px-3 py-1 rounded-full text-xs font-bold text-brand-600 shadow-sm border border-brand-100 flex items-center gap-1">
                                    <Icon name="calendar" size={12} /> {periods.find(p=>p.id===currPId)?.date || 'เลือกงวด'}
                                </span>
                                {syncing && <span className="text-xs text-gray-400 animate-pulse">กำลังซิงค์...</span>}
                            </div>
                        </div>
                        <button onClick={addPeriod} className="bg-white p-3 rounded-xl shadow-soft text-brand-600 border border-brand-50 hover:bg-brand-50 transition"><Icon name="plus" /></button>
                    </div>

                    <div className="grid gap-4 mb-8">
                        <StatCard title="กำไรสุทธิ (Profit)" value={`฿${currStats.profit.toLocaleString()}`} subtext="ยอดขาย - ต้นทุน" icon="wallet" color={currStats.profit>=0?"brand":"rose"} />
                        <div className="grid grid-cols-2 gap-4">
                            <StatCard title="ยอดขาย" value={`฿${currStats.revenue.toLocaleString()}`} icon="trending-up" color="emerald" />
                            <StatCard title="ต้นทุน" value={`฿${currStats.cost.toLocaleString()}`} icon="package" color="rose" />
                        </div>
                    </div>

                    <h3 className="text-lg font-heading font-bold text-gray-700 mb-4 px-1">ประวัติย้อนหลัง</h3>
                    <div className="bg-white rounded-2xl shadow-soft overflow-hidden">
                        {periods.map(p => {
                            const s = getStats(p.id);
                            return (
                                <div key={p.id} onClick={()=>{ setCurrPId(p.id); setTab('inv'); }} className={`p-4 border-b border-gray-50 flex justify-between items-center cursor-pointer transition active:bg-gray-50 ${currPId===p.id?'bg-brand-50/50':''}`}>
                                    <div className="flex-1">
                                        <p className="font-bold text-gray-800 text-lg">{new Date(p.date).toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'})}</p>
                                        <p className="text-xs text-gray-400 mt-0.5">ยอดขาย {s.revenue.toLocaleString()}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="text-right">
                                            <p className={`font-bold ${s.profit>=0?'text-emerald-600':'text-rose-600'}`}>{s.profit>0?'+':''}{s.profit.toLocaleString()}</p>
                                            <p className="text-[10px] text-gray-400">คลิกเพื่อดูรายละเอียด</p>
                                        </div>
                                        <div className="flex items-center pl-2 border-l border-gray-100 gap-1">
                                            <button onClick={(e)=>{e.stopPropagation(); editPeriodDate(p.id)}} className="p-3 bg-gray-50 text-brand-600 rounded-lg hover:bg-brand-100 transition"><Icon name="pencil" size={18}/></button>
                                            <button onClick={(e)=>{e.stopPropagation(); deletePeriod(p.id)}} className="p-3 bg-gray-50 text-rose-500 rounded-lg hover:bg-rose-100 transition"><Icon name="trash-2" size={18}/></button>
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            );

            // --- Layout ---
            if (loading) return (
                <div className="h-screen flex items-center justify-center bg-gray-50 flex-col gap-4">
                    <div className="w-12 h-12 border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
                    <p className="text-gray-400 font-heading">กำลังโหลดข้อมูล...</p>
                </div>
            );

            return (
                <div className="h-full flex flex-col md:flex-row bg-gray-50 max-w-7xl mx-auto w-full shadow-2xl overflow-hidden md:rounded-3xl md:my-4 md:h-[95vh] md:border md:border-gray-200">
                    
                    {/* Desktop Sidebar */}
                    <div className="hidden md:flex w-64 bg-white border-r border-gray-100 flex-col p-6 z-20">
                        <h1 className="text-2xl font-heading font-bold text-brand-600 mb-8 flex items-center gap-2"><Icon name="clover" className="text-brand-500" /> Lottery Pro</h1>
                        <nav className="space-y-2 flex-1">
                            {[
                                {id: 'dashboard', l: 'ภาพรวม', i: 'layout-dashboard'},
                                {id: 'inv', l: 'จัดการต้นทุน', i: 'package'},
                                {id: 'sale', l: 'บันทึกยอดขาย', i: 'shopping-cart'},
                                {id: 'report', l: 'รายงาน', i: 'pie-chart'},
                                {id: 'data', l: 'ข้อมูล', i: 'database'}
                            ].map(m => (
                                <button key={m.id} onClick={()=>setTab(m.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-all ${tab===m.id ? 'bg-brand-600 text-white shadow-lg shadow-brand-200' : 'text-gray-500 hover:bg-gray-50'}`}>
                                    <Icon name={m.i} size={20} /> {m.l}
                                </button>
                            ))}
                        </nav>
                    </div>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col relative overflow-hidden bg-[#F8FAFC]">
                        {tab === 'dashboard' && <Dashboard />}
                        {tab === 'inv' && <ListView mode="inv" />}
                        {tab === 'sale' && <ListView mode="sale" />}
                        {tab === 'report' && <ReportsView />}
                        {tab === 'data' && (
                            <div className="p-6 overflow-y-auto custom-scroll pb-24">
                                <h2 className="text-2xl font-heading font-bold text-gray-800 mb-6">จัดการข้อมูล</h2>
                                <div className="space-y-6 max-w-3xl mx-auto">
                                    <section>
                                        <h3 className="text-lg font-bold text-gray-700 mb-3 flex items-center gap-2"><Icon name="save" size={20} className="text-brand-600"/> สำรองและกู้คืน (Backup & Restore)</h3>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div className="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 hover:shadow-md transition">
                                                <h4 className="font-bold text-gray-800 mb-1">Backup (JSON)</h4>
                                                <p className="text-sm text-gray-400 mb-4">สำรองข้อมูลทั้งหมดเก็บไว้</p>
                                                <button className="bg-brand-50 text-brand-600 hover:bg-brand-100 w-full py-3 rounded-xl font-bold transition flex items-center justify-center gap-2" onClick={()=>{
                                                    const b = new Blob([JSON.stringify({periods,inventory,sales})],{type:'application/json'});
                                                    const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
                                                }}><Icon name="download" size={18}/> ดาวน์โหลด Backup</button>
                                            </div>
                                            <div className="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 hover:shadow-md transition">
                                                <h4 className="font-bold text-gray-800 mb-1">Restore (JSON)</h4>
                                                <p className="text-sm text-gray-400 mb-4">กู้คืนข้อมูลจากไฟล์ Backup</p>
                                                <label className="bg-white border-2 border-brand-100 text-brand-600 hover:border-brand-300 w-full py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer">
                                                    <Icon name="upload" size={18}/> เลือกไฟล์กู้คืน
                                                    <input type="file" accept=".json" className="hidden" onChange={handleImportJSON} />
                                                </label>
                                            </div>
                                        </div>
                                    </section>
                                    <section>
                                        <h3 className="text-lg font-bold text-gray-700 mb-3 flex items-center gap-2"><Icon name="file-spreadsheet" size={20} className="text-emerald-600"/> Excel / CSV</h3>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div className="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 hover:shadow-md transition">
                                                <h4 className="font-bold text-gray-800 mb-1">ส่งออก (Export CSV)</h4>
                                                <p className="text-sm text-gray-400 mb-4">นำไปวิเคราะห์ต่อใน Excel</p>
                                                <button className="bg-emerald-50 text-emerald-600 hover:bg-emerald-100 w-full py-3 rounded-xl font-bold transition flex items-center justify-center gap-2" onClick={()=>{
                                                    const h = ["Date","Cost","Revenue","Profit"];
                                                    const r = periods.map(p=>{const s=getStats(p.id); return [p.date,s.cost,s.revenue,s.profit]});
                                                    const c = [h.join(','),...r.map(x=>x.join(','))].join('\n');
                                                    const b = new Blob(["\uFEFF"+c],{type:'text/csv;charset=utf-8;'});
                                                    const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`report_${new Date().toISOString().slice(0,10)}.csv`; a.click();
                                                }}><Icon name="download" size={18}/> ดาวน์โหลด CSV</button>
                                            </div>
                                            <div className="bg-white p-5 rounded-2xl shadow-soft border border-gray-100 hover:shadow-md transition">
                                                <h4 className="font-bold text-gray-800 mb-1">นำเข้า (Import CSV)</h4>
                                                <p className="text-sm text-gray-400 mb-4">รูปแบบ: วันที่, ต้นทุน, ยอดขาย</p>
                                                <label className="bg-white border-2 border-emerald-100 text-emerald-600 hover:border-emerald-300 w-full py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer">
                                                    <Icon name="upload" size={18}/> เลือกไฟล์ CSV
                                                    <input type="file" accept=".csv" className="hidden" onChange={handleImportCSV} />
                                                </label>
                                            </div>
                                        </div>
                                    </section>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Mobile Bottom Nav */}
                    <div className="md:hidden bg-white border-t border-gray-100 flex justify-around p-2 pb-safe z-30 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                        {[
                            {id: 'dashboard', l: 'ภาพรวม', i: 'layout-dashboard'},
                            {id: 'inv', l: 'ต้นทุน', i: 'package'},
                            {id: 'sale', l: 'ขาย', i: 'shopping-cart'},
                            {id: 'report', l: 'รายงาน', i: 'pie-chart'},
                            {id: 'data', l: 'ข้อมูล', i: 'database'}
                        ].map(m => (
                            <button key={m.id} onClick={()=>setTab(m.id)} className={`flex flex-col items-center justify-center w-16 h-14 rounded-2xl transition-all ${tab===m.id ? 'text-brand-600' : 'text-gray-400'}`}>
                                <div className={`mb-1 transition-transform ${tab===m.id?'scale-110 -translate-y-1':''}`}>
                                    <Icon name={m.i} size={24} className={tab===m.id ? 'fill-brand-100' : ''} />
                                </div>
                                <span className="text-[10px] font-bold">{m.l}</span>
                            </button>
                        ))}
                    </div>

                    {toast && <Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
